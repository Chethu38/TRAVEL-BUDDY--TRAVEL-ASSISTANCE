<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>{{ city.name }} ‚Äî Travel Buddy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: "#6D28D9" }}}
    }
  </script>

  <style>
    /* small modal styles */
    .modal-backdrop {
      background: rgba(0,0,0,0.5);
    }
    .modal-card { max-width: 900px; }
  </style>
</head>

<body class="bg-white text-gray-900 min-h-screen">

<header class="bg-brand text-white shadow-md sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">{{ city.name }} City Guide</h1>

    <nav class="flex gap-5 text-sm">
      <a href="{{ url_for('home') }}" class="hover:underline">Home</a>
      <a href="{{ url_for('home') }}" class="hover:underline">Search</a>
      <a href="{{ url_for('home') }}" class="hover:underline">Profile</a>
      <a href="{{ url_for('home') }}" class="hover:underline">Settings</a>
      <a href="{{ url_for('home') }}" class="text-red-200 hover:text-red-100">Logout</a>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8 space-y-10">

  <section class="border border-gray-200 rounded-2xl shadow overflow-hidden bg-white">
    <img src="{{ city.heroImage }}" class="w-full h-64 object-fill bg-gray-100"/>

    <div class="p-6 space-y-2">
      <h2 class="text-2xl font-bold">{{ city.name }}</h2>
      <p class="text-sm text-gray-600">{{ city.description }}</p>

      <p class="text-xs text-brand font-semibold">
         Lat {{ city.lat }}, Lng {{ city.lng }}
      </p>

      <!-- üå§ WEATHER CARD (kept) -->
      <div
        id="weather-card"
        class="mt-3 inline-flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-xs bg-purple-50 border border-purple-100 rounded-xl px-3 py-2"
      >
        <div>
          <div id="weather-temp" class="font-semibold text-brand">--¬∞C</div>
          <div id="weather-desc" class="text-gray-600">Loading weather...</div>
        </div>
        <div id="weather-note" class="text-[11px] text-gray-500 max-w-xs">
          Checking if it's a good time to explore...
        </div>
      </div>

      <!-- BUTTON GROUP -->
      <div class="mt-4 flex flex-wrap gap-3">

        <!-- View City on Map -->
        <button
          type="button"
          data-city-hero="1"
          data-lat="{{ city.lat }}"
          data-lng="{{ city.lng }}"
          onclick="openCityMap(this)"
          class="px-4 py-2 text-xs bg-brand rounded-lg text-white hover:bg-purple-800">
           View City on Map
        </button>

        <!-- ‚≠ê CITY HISTORY BUTTON (NEW: fetches city info + crowd) -->
        <button
          id="city-history-btn"
          type="button"
          data-city-name="{{ city.name }}"
          class="px-4 py-2 text-xs border border-brand text-brand rounded-lg hover:bg-purple-50">
          üìú City History & Crowd
        </button>

        <!-- (kept) You wanted to remove link to account history ‚Äî it's removed here -->

      </div>

    </div>
  </section>

  <!-- FOODS -->
  <section class="space-y-4">
    <h3 class="text-lg font-semibold text-brand">üçΩ Foods</h3>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% set any_food = false %}
      {% for p in places if p.type and (p.type|lower in ['food','restaurant','cafe','eatery','dining']) %}
      {% set any_food = true %}
      <article class="border border-gray-200 rounded-2xl overflow-hidden shadow bg-white flex flex-col">
        <img src="{{ (p.images[0] if p.images else '/static/images/placeholder.jpg') }}" class="w-full h-36 object-fill bg-gray-100"/>
        <div class="p-4 flex flex-col gap-1">
          <h4 class="font-semibold">{{ p.name }}</h4>
          <p class="text-xs text-gray-500">{{ p.address }}</p>
          <p class="text-xs text-gray-600">‚è∞ {{ p.openTime or 'N/A' }} ‚Äì {{ p.closeTime or 'N/A' }}</p>
          <p class="text-xs text-gray-700 mt-1 line-clamp-3">{{ p.description }}</p>
          <a href="{{ url_for('view_place', place_id=p.id) }}" class="px-3 py-1.5 rounded border border-brand text-brand text-xs hover:bg-purple-50">‚Ñπ View Details</a>
        </div>
      </article>
      {% endfor %}
      {% if not any_food %}
      <div class="col-span-full text-sm text-gray-600">No food spots available for this city.</div>
      {% endif %}
    </div>
  </section>

  <!-- EXPLORE -->
  <section class="space-y-4">
    <h3 class="text-lg font-semibold text-brand">üìå Places to Explore</h3>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% set any_places = false %}
      {% for p in places if p.type and (p.type|lower in ['place','attraction','sight','monument','temple','park','museum']) %}
      {% set any_places = true %}
      <article class="border border-gray-200 rounded-2xl overflow-hidden shadow bg-white flex flex-col">
        <img src="{{ (p.images[0] if p.images else '/static/images/placeholder.jpg') }}" class="w-full h-36 object-fill bg-gray-100"/>
        <div class="p-4 flex flex-col gap-1">
          <h4 class="font-semibold">{{ p.name }}</h4>
          <p class="text-xs text-gray-500">{{ p.address }}</p>
          <p class="text-xs text-gray-600">‚è∞ {{ p.openTime or 'N/A' }} ‚Äì {{ p.closeTime or 'N/A' }}</p>
          <p class="text-xs text-gray-700 mt-1 line-clamp-3">{{ p.description }}</p>
          <a href="{{ url_for('view_place', place_id=p.id) }}" class="px-3 py-1.5 rounded border border-brand text-brand text-xs hover:bg-purple-50">‚Ñπ View Details</a>
        </div>
      </article>
      {% endfor %}
      {% if not any_places %}
      <div class="col-span-full text-sm text-gray-600">No places to explore listed for this city.</div>
      {% endif %}
    </div>
  </section>

  <!-- HOTELS -->
  <section class="space-y-4">
    <h3 class="text-lg font-semibold text-brand">üè® Hotels & Stay</h3>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% set any_hotels = false %}
      {% for p in places if p.type and (p.type|lower in ['hotel','stay','guesthouse','lodging','accommodation']) %}
      {% set any_hotels = true %}
      <article class="border border-gray-200 rounded-2xl overflow-hidden shadow bg-white flex flex-col">
        <img src="{{ (p.images[0] if p.images else '/static/images/placeholder.jpg') }}" class="w-full h-36 object-fill bg-gray-100"/>
        <div class="p-4 flex flex-col gap-1">
          <h4 class="font-semibold">{{ p.name }}</h4>
          <p class="text-xs text-gray-500">{{ p.address }}</p>
          <p class="text-xs text-gray-600">‚è∞ {{ p.openTime or 'N/A' }} ‚Äì {{ p.closeTime or 'N/A' }}</p>
          <p class="text-xs text-gray-700 mt-1 line-clamp-3">{{ p.description }}</p>
          <a href="{{ url_for('view_place', place_id=p.id) }}" class="px-3 py-1.5 rounded border border-brand text-brand text-xs hover:bg-purple-50">‚Ñπ View Details</a>
        </div>
      </article>
      {% endfor %}
      {% if not any_hotels %}
      <div class="col-span-full text-sm text-gray-600">No hotels or stays listed for this city.</div>
      {% endif %}
    </div>
  </section>

</main>

<!-- MODAL (hidden by default) -->
<div id="info-modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 modal-backdrop" onclick="closeModal()"></div>
  <div class="bg-white rounded-2xl shadow-lg p-6 modal-card mx-4 max-h-[85vh] overflow-auto z-60">
    <div class="flex justify-between items-start gap-4">
      <h3 id="modal-title" class="text-lg font-semibold">City Info</h3>
      <button class="text-xs px-2 py-1 rounded border" onclick="closeModal()">Close</button>
    </div>

    <div id="modal-body" class="mt-4 text-sm space-y-3">
      <!-- content populated by JS -->
      <div id="modal-summary" class="prose"></div>

      <div id="modal-crowd" class="mt-2">
        <strong>Crowd prediction:</strong> <span id="modal-crowd-val">‚Äî</span>
      </div>

      <div id="modal-more" class="mt-3 text-xs text-gray-600"></div>
    </div>
  </div>
</div>

<script>
/* ---------- keep weather flow (unchanged) ---------- */
const WEATHER_API_KEY = "your api key1"; // existing key in your app

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.querySelector("[data-city-hero]");
  if (!btn) return;
  const lat = parseFloat(btn.dataset.lat);
  const lng = parseFloat(btn.dataset.lng);
  fetchCityWeather(lat, lng);
});

/* fetch weather (same as before) */
async function fetchCityWeather(lat, lng) {
  if (!WEATHER_API_KEY) return;
  try {
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${WEATHER_API_KEY}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error("Weather fetch failed");
    const data = await resp.json();
    document.getElementById("weather-temp").textContent = Math.round(data.main.temp) + "¬∞C";
    document.getElementById("weather-desc").textContent = data.weather[0].description;
  } catch (e) {
    console.error("Weather error", e);
    document.getElementById("weather-desc").textContent = "Unable to load weather";
  }
}

function openCityMap(btn) {
  const lat = btn.dataset.lat;
  const lng = btn.dataset.lng;
  window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, "_blank");
}

/* ---------- CITY HISTORY button behavior (NEW) ---------- */

/*
  Behavior:
   - When user clicks City History button:
       1) Try to query Google Knowledge Graph API (if GOOGLE_API_KEY provided).
          * This requires you to supply an API key (instructions below).
       2) If Google isn't available or returns nothing, fallback to Wikipedia summary.
       3) Also call your backend crowd prediction endpoint: /predict_crowd?city=CityName
       4) Show results in a modal.
   - IMPORTANT: This template does not require any app.py modification to work.
     The Wikipedia + crowd fallback works out-of-the-box. Google is optional.
*/

document.getElementById("city-history-btn").addEventListener("click", async function () {
  const cityName = this.dataset.cityName || "{{ city.name }}";
  showModal("Loading...", "Fetching information...");

  // 1) get crowd prediction from your backend endpoint (keeps using your app.py /predict_crowd)
  //    endpoint: GET /predict_crowd?city=CityName
  const crowdPromise = fetch(`/predict_crowd?city=${encodeURIComponent(cityName)}`)
    .then(r => r.ok ? r.json() : { error: "crowd fetch failed" })
    .catch(e => ({ error: "crowd fetch failed" }));

  // 2) Try Google Knowledge Graph first if key provided inline (OPTIONAL).
  //    To use Google KG: set window.GOOGLE_KG_API_KEY to your key (see instructions below).
  const googleKey = window.GOOGLE_KG_API_KEY || null;

  let summary = null;
  let moreHtml = "";

  if (googleKey) {
    try {
      // Knowledge Graph Search API (needs API key & billing enabled)
      // Note: For production you'll want to call this from server (to hide key).
      const kgUrl = `https://kgsearch.googleapis.com/v1/entities:search?query=${encodeURIComponent(cityName)}&limit=1&indent=true&key=${googleKey}`;
      const kgResp = await fetch(kgUrl);
      if (kgResp.ok) {
        const kgJson = await kgResp.json();
        if (kgJson && kgJson.itemListElement && kgJson.itemListElement.length) {
          const item = kgJson.itemListElement[0].result;
          summary = item['detailedDescription'] ? item['detailedDescription']['articleBody'] : item['description'] || null;
          if (item['detailedDescription'] && item['detailedDescription']['url']) {
            moreHtml += `<div>Source: <a target="_blank" href="${item['detailedDescription']['url']}">Google</a></div>`;
          }
        }
      }
    } catch (e) {
      console.warn("Google KG fetch failed, falling back to Wikipedia", e);
    }
  }

  // 3) Fallback: Wikipedia summary (no API key, works without backend)
  if (!summary) {
    try {
      // Use Wikipedia REST API to get page summary
      // 2-step: search for the best page, then get its summary
      const searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(cityName)}&format=json&origin=*`;
      const searchResp = await fetch(searchUrl);
      const searchJson = await searchResp.json();
      let pageTitle = null;
      if (searchJson && searchJson.query && searchJson.query.search && searchJson.query.search.length) {
        pageTitle = searchJson.query.search[0].title;
      }

      if (pageTitle) {
        const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
        const summaryResp = await fetch(summaryUrl);
        const summaryJson = await summaryResp.json();
        if (summaryJson && summaryJson.extract) {
          summary = summaryJson.extract;
          if (summaryJson.content_urls && summaryJson.content_urls.desktop && summaryJson.content_urls.desktop.page) {
            moreHtml += `<div>Source: <a target="_blank" href="${summaryJson.content_urls.desktop.page}">Wikipedia</a></div>`;
          }
        }
      }
    } catch (e) {
      console.warn("Wikipedia fetch failed", e);
    }
  }

  // 4) Wait for crowd prediction
  const crowdJson = await crowdPromise;
  let crowdText = "Unavailable";
  if (crowdJson && !crowdJson.error && (crowdJson.predicted_crowd !== undefined)) {
    crowdText = `${crowdJson.predicted_crowd}% ‚Äî ${crowdJson.message || ""}`;
  }

  // 5) Build modal content
  const summaryHtml = summary ? `<p>${escapeHtml(summary)}</p>` : `<p>No short history found.</p>`;
  const html = `${summaryHtml}${moreHtml}`;

  // populate modal
  document.getElementById("modal-summary").innerHTML = html;
  document.getElementById("modal-crowd-val").textContent = crowdText;
  document.getElementById("modal-title").textContent = `${cityName} ‚Äî Info & Crowd`;
  openModal();
});

/* ---------- modal helpers ---------- */
function showModal(title, bodyText) {
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-summary").textContent = bodyText;
  document.getElementById("modal-crowd-val").textContent = "‚Äî";
  openModal();
}

function openModal() {
  const el = document.getElementById("info-modal");
  el.classList.remove("hidden");
  el.style.display = "flex";
  document.body.style.overflow = "hidden";
}

function closeModal() {
  const el = document.getElementById("info-modal");
  el.classList.add("hidden");
  el.style.display = "none";
  document.body.style.overflow = "";
}

/* small helper to avoid injection when inserting text */
function escapeHtml(unsafe) {
  return String(unsafe)
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
}
</script>

</body>
</html>

